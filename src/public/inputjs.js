const L=[9,7,9,4,0,4,-3,null,9,7,9,4,0,4,-3,null,9,11,12,11,12,9,11,9,11,7,9,7,9,5,9,null,9,7,9,4,0,4,-3,null],N=[null,null,-1,null,-8,null,-1,null,-8,null,-1,null,-8,null,-1,null,-8,null,-1,null,-8,null,-3,null,-10,null,-5,null-12,null,-5,null-12,null,-1,null,-8,null,-1,null,-8,null,-1,null,-8,null];function B(c){return 440*Math.pow(2,(c-69)/12)}class g{constructor(o){this.actx=o,this.out=this.comp(),this.out.connect(o.destination),this.A=0,this.D=.75,this.S=0,this.R=0,this.notes={}}envelope(o,n,t,r){this.A=o,this.D=n,this.S=t,this.R=r}osc(o,n,t=0){let r=this.actx.createOscillator();return r.type=o,r.frequency.value=n,r.detune.value=t,r.start(),r}amp(){let o=this.actx.createGain();return o.gain.value=0,o}comp(){let o=this.actx.createDynamicsCompressor();return o.threshold.value=0,o.knee.value=20,o.ratio.value=5,o.attack.value=0,o.release.value=.24,o}play(o,n,t,r=1,a="sawtooth"){if(!o)return;let i=B(o);console.log(i);let l=this.A*t,m=this.D*t,T=this.R*t,E=this.osc(a,i,0),A=this.amp();A.gain.setValueAtTime(0,n),A.connect(this.out),E.connect(A),A.gain.linearRampToValueAtTime(r,n+l),A.gain.linearRampToValueAtTime(0,n+l+m+T),E.stop(n+l+m+T)}}var M=`#version 300 es
precision highp float;uniform sampler2D u_texture;uniform vec2 iResolution;uniform float iTime;in vec2 vUv;out vec4 fragColor;uniform int boardstate[64];
#define MAX_STEPS 70
const float frameCount=8.0;const float pixelsPrFrame=16.0;float pixelsX=frameCount*pixelsPrFrame;float sdSphere(vec3 p,float radius){return length(p-1.5-sin(iTime)*1.0+vec3(sin(iTime),0.0,0.0))-radius;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 perm(vec4 x){return mod289(((x*34.0)+1.0)*x);}float noise(vec3 p){vec3 a=floor(p);vec3 d=p-a;d=d*d*(3.0-2.0*d);vec4 b=a.xxyy+vec4(0.0,1.0,0.0,1.0);vec4 k1=perm(b.xyxy);vec4 k2=perm(k1.xyxy+b.zzww);vec4 c=k2+a.zzzz;vec4 k3=perm(c);vec4 k4=perm(c+1.0);vec4 o1=fract(k3*(1.0/41.0));vec4 o2=fract(k4*(1.0/41.0));vec4 o3=o2*d.z+o1*(1.0-d.z);vec2 o4=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}float fbm(vec3 p){vec3 q=p+iTime*0.5*vec3(1.0,-0.2,-1.0);float g=noise(q);float f=0.0;float scale=0.5;float factor=2.02;for(int i=0;i<6;i++){f+=scale*noise(q);q*=factor;factor+=0.21;scale*=0.5;}return f;}float scene(vec3 p){float distance=sdSphere(p,1.0);float f=fbm(p);return-distance+f;}const float MARCH_SIZE=0.08;vec4 raymarch(vec3 rayOrigin,vec3 rayDirection){float depth=0.0;vec3 p=rayOrigin+depth*rayDirection;vec4 res=vec4(0.0);for(int i=0;i<MAX_STEPS;i++){float density=scene(p);if(density>0.0){vec4 color=vec4(mix(vec3(1.0,1.0,1.0),vec3(0.0,sin(iTime),0.0),density),density);color.rgb*=color.a;res+=color*(1.0-res.a);}depth+=MARCH_SIZE;p=rayOrigin+depth*rayDirection;}return res;}void main(){vec3 ro=vec3(0.0,0.0,5.0);vec2 uv=vUv.xy;uv+=1.0;uv*=0.5;uv.y=1.0-uv.y;float frame=float(boardstate[0]);float xPos=float(boardstate[1]);float timeScaled=iTime/10.0;float deltaX=mod(xPos/1500.0,1.1);float deltaY=0.0;vec2 catX=vec2(-0.2+deltaX,0.0+deltaX);vec2 catY=vec2(0.2+deltaY,0.3+deltaY);float scaleX=1.0/(catX.y-catX.x);float scaleY=1.0/(catY.y-catY.x);vec3 ray_direction=normalize(vec3(uv,-1.0));if(uv.x>catX.x&&uv.x<catX.y&&uv.y>catY.x&&uv.y<catY.y){vec2 catPos=vec2(0.0,0.0);catPos.x=(uv.x-catX.x)*scaleX/frameCount+frame*pixelsPrFrame/pixelsX;catPos.y=(uv.y-catY.x)*scaleY;fragColor=textureLod(u_texture,catPos,0.0);if(fragColor.a<0.1){fragColor=vec4(raymarch(ro,ray_direction).rgb,1.0);}}else{fragColor=vec4(raymarch(ro,ray_direction).rgb,1.0);}}`;const _=new Int32Array(64);async function k(){const c=document.createElement("style");c.textContent=`
  #c {
    height: 450px;
    aspect-ratio: 1/1;
    background-color: lightgreen;
  }
`,document.head.appendChild(c);const o=document.createElement("canvas");o.id="c",document.body.appendChild(o);const n=document.createElement("button");n.textContent="When not running with autoplay enabled this must be clicked",n.onclick=function(){h=new AudioContext,y=new g(h),y.envelope(.01,.2,0,.01),R=new g(h),R.envelope(.01,.2,.2,.01),h.resume(),v=h.currentTime,p=[...S],x=[...w],requestAnimationFrame(b),D()},document.body.appendChild(n);const t=o.getContext("webgl2",{antialias:!0},"true");if(!t){console.error("WebGL not supported");return}const r=`#version 300 es 
precision highp float;

in vec4 position;
out vec2 vUv;

void main() {
    vUv = position.xy;
    gl_Position = position; 
  }
  `;function a(e,f){const s=document.createElement("img");s.id="texture",s.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAVCAMAAAAn8RGpAAAAAXNSR0IArs4c6QAAAA9QTFRFAAAAAAAAOjo6UVFRbW1t/kAd+gAAAAV0Uk5TAP////8c0CZSAAABH0lEQVRIieWXAQ7DIAhFRbn/mVdBLHRaMavZzMhi5/vsi7HVNYQcAKEZ23DEprIPT01hI56qAmfr4j2fp7ijHiMAXaUd8+kJT3JfPUZIEIB6Tl6NFnFnPVoAEvw8LOb39fDCiAAxlQAXNwMs4I56yg/wFA4f+ni5GWABH9TDS4PlhGAjZCMnrwMs4oN6+B6qe0FWEPN6+rgyWsId9RwdmuA1nFwNsIQ76uGHI1KUS4xOHjs+T3FHPSLYOHeDAX8b4GE+rufDCXyf/1xBfzgBQFQacsA2nI7xa0CHy5+/qfyef89nlvN7jo56XFshgkwgfzfpEW7yu/5tH8pW+2rp9sfNN5F51ZQunR2gcOny4afTg/Bm/o1/ywdqU7E0zfwXvmIbea4eByYAAAAASUVORK5CYII=",document.body.appendChild(s),s.onload=()=>{const d=document.getElementById("texture");if(d){const u=e.createTexture();e.bindTexture(e.TEXTURE_2D,u),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,d);const O=e.getUniformLocation(f,"u_texture");e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,u),e.uniform1i(O,0)}else return console.log("No image texture found, most shaders here do not use them"),""}}function i(e,f,s){const d=e.createShader(f);return e.shaderSource(d,s),e.compileShader(d),e.getShaderParameter(d,e.COMPILE_STATUS)?d:(console.error("Error compiling shader:",e.getShaderInfoLog(d)),e.deleteShader(d),null)}async function l(e){const f=M,s=i(e,e.FRAGMENT_SHADER,f),d=i(e,e.VERTEX_SHADER,r),u=e.createProgram();return e.attachShader(u,d),e.attachShader(u,s),e.linkProgram(u),e.useProgram(u),e.getProgramParameter(u,e.LINK_STATUS)?(a(e,u),u):(console.error("Error linking program:",e.getProgramInfoLog(u)),e.deleteProgram(u),null)}const m=await l(t),T=t.getAttribLocation(m,"position"),E=t.getUniformLocation(m,"iResolution"),A=t.getUniformLocation(m,"iTime"),P=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,P);const C=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];t.bufferData(t.ARRAY_BUFFER,new Float32Array(C),t.STATIC_DRAW);function I(e){const f=e.clientWidth,s=e.clientHeight;(e.width!==f||e.height!==s)&&(e.width=f,e.height=s)}let U=0;function b(){I(t.canvas);let e=h.currentTime;t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT),t.enableVertexAttribArray(T),t.bindBuffer(t.ARRAY_BUFFER,P),t.vertexAttribPointer(T,2,t.FLOAT,!1,0,0),t.uniform2f(E,t.canvas.width,t.canvas.height),t.uniform1f(A,e);const f=t.getUniformLocation(m,"boardstate");let s=e*4%8;U+=1,t.uniform1iv(f,_),_[0]=parseInt(s),_[1]=parseInt(U),t.drawArrays(t.TRIANGLES,0,6),requestAnimationFrame(b)}}let h,y,R,v=0;const X=.25,S=L.reduce(function(c,o,n){let r=c[n-1]?.on||0,a=c[n-1]?.dur||0,i={note:o==null?o:o+60,on:r+a,dur:1*X};return c.push(i),c},[]),w=N.reduce(function(c,o,n){let r=c[n-1]?.on||0,a=c[n-1]?.dur||0,i={note:o==null?o:o+41,on:r+a,dur:1*X};return c.push(i),c},[]);let F;const Y=.75;let p=[...S];console.log(p);let x=[...w];function D(c){let o=S[S.length-2],n=o.on+o.dur,t=h.currentTime-v;if(F=requestAnimationFrame(D),t>n){cancelAnimationFrame(F);return}let r=t+Y;for(;p.length&&p[0].on<r;){let{note:a,on:i,dur:l}=p[0];console.log("pop from queue for scheudling",a,i,l),p.splice(0,1),a!=null&&(y.play(a,v+i,l,1,"sawtooth"),y.play(a+4,v+i+.02,l,.2,"sine"),y.play(a+7,v+i+.04,l,.3,"sine"))}for(;x.length&&x[0].on<r;){let{note:a,on:i,dur:l}=x[0];x.splice(0,1),console.log("pop from bass queue for scheudling",a,i,l),a!=null&&(R.play(a,v+i,l*2,3,"sawtooth"),R.play(a+7,v+i+.04,l*4,.3,"sawtooth"))}}k();
